name: Test & Deploy
on:
  - release:
      types: [created]
  - push:
      branches:
        - master
  - pull_request:
      branches:
        - master

jobs:
  test:
    runs-on: ubuntu-18.04
    steps:
      - name: Set up Go 1.13
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
        id: go
      - name: Check out code into the Go module directory
        uses: actions/checkout@v1
      - name: Test
        run: ./hack/coverage.bash
  deploy:
    if: startsWith(github.ref, 'refs/tags/v') == true
    needs: test
    runs-on: macOS-latest
    steps:
      - name: Set up Go 1.13
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
        id: go
      - name: Check out code into the Go module directory
        uses: actions/checkout@v1
      - name: Compile binaries
        env:
          ANALYTICS_TOKEN: "test"
          ANALYTICS_ENDPOINT_EVENT: "test"
          ANALYTICS_ENDPOINT_USER: "test"
        run: ./hack/build-all.bash
      - name: Get the version
        id: version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
      - name: Publish
        uses: radiusnetworks/release-asset-action@v1
        with:
          pattern: "release/*"
          github-token: ${{ secrets.GITHUB_TOKEN }}
